name: PR Quality & Security Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  fill-marker-regression:
    name: Placeholder Regression Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get install -y ripgrep

      - name: Check [FILL:] marker regressions
        run: bash scripts/check-fill-markers.sh .fill-marker-baseline

  template-quality:
    name: Template Quality Gate
    runs-on: ubuntu-latest
    needs: [fill-marker-regression]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y ripgrep python3

      - name: Run check-all
        run: bash scripts/check-all.sh

  secret-scan:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          GITLEAKS_VERSION="8.24.2"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run Gitleaks Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gitleaks detect --source . --verbose

  script-analysis:
    name: Script Safety (ShellCheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          if [ -d ".agent/scripts" ]; then
            find .agent/scripts -type f -name '*.sh' -print0 | xargs -0 -r shellcheck -S warning
          else
            echo "No .agent/scripts directory found; skipping ShellCheck."
          fi

  pr-analysis:
    name: Paranoid PR Analysis & AI Review
    runs-on: ubuntu-latest
    needs: [template-quality, secret-scan, script-analysis]
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
    steps:
      - name: Checkout Code
        if: env.JULES_API_KEY != ''
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies (jq, python)
        if: env.JULES_API_KEY != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      - name: Authenticate with GitHub CLI
        if: env.JULES_API_KEY != ''
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run analyze_pr.sh
        if: env.JULES_API_KEY != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash .agent/scripts/analyze_pr.sh ${{ github.event.pull_request.number }}

      - name: Skip message when JULES_API_KEY is missing
        if: env.JULES_API_KEY == ''
        run: echo "JULES_API_KEY is not configured, skipping AI PR analysis."
