name: Documentation Drift Audit

on:
  pull_request:
    paths:
      - '**.md'
      - '.agent/**'
      - '.claude/**'
      - '.github/instructions/**'
      - '.github/prompts/**'
      - '.agents/**'
  schedule:
    - cron: '0 2 * * *' # Run nightly at 2 AM
  workflow_dispatch: # Allow manual triggering

jobs:
  doc-audit:
    name: Audit Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Markdown Linting
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'
          # Note: If you want to use a config file, create a .markdownlint.yaml

      - name: Run custom doc-drift script (Stub)
        run: |
          echo "Running documentation drift audit..."
          # Check for broken internal markdown links
          broken_links=0
          for file in $(find . -name '*.md' -not -path './.git/*' -not -path './node_modules/*'); do
            # Find markdown links to local files and verify they exist
            grep -oP '\]\((?!http|#|mailto)([^)]+)\)' "$file" | sed 's/\](//;s/)//' | while read -r link; do
              # Strip anchor fragments
              target=$(echo "$link" | sed 's/#.*//')
              if [ -n "$target" ] && [ ! -e "$target" ]; then
                echo "BROKEN LINK in $file: $link"
                broken_links=$((broken_links + 1))
              fi
            done
          done
          # Check for stale [FILL:] markers in non-template files
          fill_count=$(grep -rn '\[FILL:' . --include='*.md' \
            --exclude='README.md' \
            --exclude='CUSTOMIZATION-GUIDE.md' \
            --exclude='CHANGELOG.md' \
            --exclude-dir='.git' | wc -l)
          echo "Found $fill_count [FILL:] markers remaining in non-excluded files."
          echo "For deep drift detection, run the agent workflow /doc-audit."
