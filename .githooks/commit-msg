#!/usr/bin/env bash
# .githooks/commit-msg â€” Repo-local commit-msg hook
#
# Validates the commit message format: type(optional-scope): description
# Matches conventional commits: feat, fix, docs, style, refactor, test, chore, ci, perf, build, revert
#
# Setup: git config core.hooksPath .githooks

set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(head -1 "$COMMIT_MSG_FILE")

# Skip merge commits and fixup/squash commits
if echo "$COMMIT_MSG" | grep -qE '^(Merge |fixup! |squash! )'; then
  exit 0
fi

# Validate conventional commit format
PATTERN='^(feat|fix|docs|style|refactor|test|chore|ci|perf|build|revert)(\([a-zA-Z0-9_-]+\))?: .{1,}'

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
  echo "[commit-msg] ERROR: Commit message does not follow conventional format."
  echo ""
  echo "  Expected: type(optional-scope): description"
  echo "  Types:    feat, fix, docs, style, refactor, test, chore, ci, perf, build, revert"
  echo ""
  echo "  Examples:"
  echo "    feat(auth): add OAuth2 login flow"
  echo "    fix: resolve null pointer in config parser"
  echo "    docs: update API reference"
  echo ""
  echo "  Got: $COMMIT_MSG"
  exit 1
fi
